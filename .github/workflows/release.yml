name: Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # Update bun.lock when release PR is created/updated
      - name: Checkout release PR branch
        if: ${{ steps.release.outputs.pr != '' }}
        # Note: Using v4 which is the latest stable version (v6 does not exist)
        uses: actions/checkout@v4
        with:
          ref: ${{ fromJson(steps.release.outputs.pr).headBranchName }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Bun
        if: ${{ steps.release.outputs.pr != '' }}
        uses: oven-sh/setup-bun@v2

      - name: Update bun.lock
        if: ${{ steps.release.outputs.pr != '' }}
        run: bun install

      - name: Commit updated bun.lock
        if: ${{ steps.release.outputs.pr != '' }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add bun.lock
          git diff --staged --quiet || git commit -m "chore: update bun.lock"
          git push

  build-binaries:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: bun-darwin-arm64
            artifact: agent-darwin-arm64
          - os: ubuntu-latest
            target: bun-linux-x64
            artifact: agent-linux-x64
          - os: ubuntu-24.04-arm
            target: bun-linux-arm64
            artifact: agent-linux-arm64
          - os: windows-latest
            target: bun-windows-x64
            artifact: agent-windows-x64.exe

    runs-on: ${{ matrix.os }}

    steps:
      # Note: Using v4 which is the latest stable version (v6 does not exist)
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build assets
        run: bun run build:assets

      - name: Build standalone binary
        run: bun build src/index.tsx --compile --outfile ${{ matrix.artifact }} --target ${{ matrix.target }}

      - name: Package with assets (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p package
          cp ${{ matrix.artifact }} package/agent
          cp -r dist/prompts package/
          cp -r dist/_bundled_skills package/
          cp -r dist/_bundled_commands package/
          tar -czf ${{ matrix.artifact }}.tar.gz -C package .
          shasum -a 256 ${{ matrix.artifact }}.tar.gz > ${{ matrix.artifact }}.tar.gz.sha256

      - name: Package with assets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path package -Force
          Copy-Item ${{ matrix.artifact }} package/agent.exe
          Copy-Item -Recurse dist/prompts package/
          Copy-Item -Recurse dist/_bundled_skills package/
          Copy-Item -Recurse dist/_bundled_commands package/
          Compress-Archive -Path package/* -DestinationPath ${{ matrix.artifact }}.zip
          $hash = (Get-FileHash "${{ matrix.artifact }}.zip" -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ matrix.artifact }}.zip" | Out-File -Encoding UTF8 -NoNewline "${{ matrix.artifact }}.zip.sha256"

      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}.tar.gz
            ${{ matrix.artifact }}.tar.gz.sha256

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}.zip
            ${{ matrix.artifact }}.zip.sha256

  publish-release:
    needs: [release-please, build-binaries]
    if: always() && needs.release-please.outputs.release_created == 'true' && needs.build-binaries.result != 'cancelled'
    runs-on: ubuntu-latest

    steps:
      # Note: Using v4 which is the latest stable version (v6 does not exist)
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Create manifest
        run: |
          cd artifacts

          # Verify at least one .sha256 file exists
          if ! ls *.sha256 1> /dev/null 2>&1; then
            echo "Error: No .sha256 files found in artifacts directory"
            exit 1
          fi

          VERSION="${{ needs.release-please.outputs.tag_name }}"
          cat > manifest.json << EOF
          {
            "version": "$VERSION",
            "binaries": {
          EOF

          first=true
          for f in *.sha256; do
            name="${f%.sha256}"
            sha=$(awk '{print $1}' "$f")
            # Strip agent- prefix, .exe suffix, and archive extensions (.tar.gz, .zip)
            platform=$(echo "$name" | sed 's/agent-//' | sed 's/\.exe//' | sed 's/\.tar\.gz//' | sed 's/\.zip//')

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> manifest.json
            fi

            printf '    "%s": {"file": "%s", "sha256": "%s"}' "$platform" "$name" "$sha" >> manifest.json
            echo "" >> manifest.json
          done

          cat >> manifest.json << EOF

            }
          }
          EOF
          cat manifest.json

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: artifacts/*

  publish-docker:
    needs: [release-please]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest

    steps:
      # Note: Using v4 which is the latest stable version (v6 does not exist)
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION="${{ needs.release-please.outputs.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push sandbox image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.sandbox
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/agent-harness-sandbox:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/agent-harness-sandbox:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
