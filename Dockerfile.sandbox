# Agent Harness Sandbox Container
#
# Optimized container for running the agent in isolated sandbox mode.
# Includes git and common development tools for project analysis.
#
# Build:
#   docker build -f Dockerfile.sandbox -t agent-harness-sandbox .
#
# Usage (automatic via --sandbox flag):
#   agent --sandbox -p "Analyze this codebase"
#
# Manual usage:
#   docker run -it --rm \
#     -v $(pwd):/workspace \
#     -v ~/.agent:/home/agent/.agent \
#     -e OPENAI_API_KEY \
#     agent-harness-sandbox

ARG SOURCE=false
ARG VERSION=latest

# =============================================================================
# Stage 1: Build from source
# =============================================================================
FROM oven/bun:1.3-alpine AS source-builder

ARG TARGETARCH

WORKDIR /app

# Copy source
COPY package.json bun.lock ./
RUN bun install --frozen-lockfile --ignore-scripts

COPY . .

# Run postinstall after source is copied
RUN bun run scripts/postinstall.ts

# Build assets first
RUN bun run build:assets

# Compile to standalone binary for the target architecture
RUN case "${TARGETARCH}" in \
      amd64) TARGET="bun-linux-x64" ;; \
      arm64) TARGET="bun-linux-arm64" ;; \
      *) echo "Unsupported arch: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    echo "Building for ${TARGETARCH} using target ${TARGET}" && \
    bun build src/index.tsx --compile --outfile /app/agent --target ${TARGET}

# Package binary with assets
RUN mkdir -p /app/package && \
    cp /app/agent /app/package/ && \
    cp -r dist/prompts /app/package/ && \
    cp -r dist/_bundled_skills /app/package/

# =============================================================================
# Stage 2: Download pre-built binary (optional)
# =============================================================================
FROM alpine:latest AS binary-downloader

ARG TARGETARCH
ARG VERSION

RUN apk add --no-cache curl jq

WORKDIR /download

# Determine platform
RUN case "${TARGETARCH}" in \
      amd64) PLATFORM="linux-x64" ;; \
      arm64) PLATFORM="linux-arm64" ;; \
      *) echo "Unsupported arch: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    echo "PLATFORM=${PLATFORM}" > /download/env

# Get version and try to download
# Always create package directory (even if empty) to avoid COPY failures
RUN mkdir -p /download/package && \
    . /download/env && \
    REPO="danielscholl/agent-harness" && \
    if [ "${VERSION}" = "latest" ]; then \
      VERSION=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" 2>/dev/null | jq -r '.tag_name // empty') || true; \
    fi && \
    if [ -z "${VERSION}" ] || [ "${VERSION}" = "null" ]; then \
      echo "No releases found, will fallback to source build" && \
      echo "FAILED" > /download/status; \
    elif [ -n "${VERSION}" ]; then \
      ARCHIVE_URL="https://github.com/${REPO}/releases/download/${VERSION}/agent-${PLATFORM}.tar.gz" && \
      echo "Downloading from: ${ARCHIVE_URL}" && \
      if curl -fsSL "${ARCHIVE_URL}" -o /download/agent.tar.gz 2>/dev/null; then \
        tar -xzf /download/agent.tar.gz -C /download/package && \
        echo "SUCCESS" > /download/status; \
      else \
        echo "Download failed, will fallback to source build" && \
        echo "FAILED" > /download/status; \
      fi; \
    else \
      echo "FAILED" > /download/status; \
    fi

# =============================================================================
# Stage 3: Final sandbox image
# =============================================================================
FROM alpine:latest AS runtime

# Install runtime dependencies + development tools for sandbox
RUN apk add --no-cache \
    libstdc++ libgcc \
    git curl jq \
    openssh-client \
    && rm -rf /var/cache/apk/*

WORKDIR /app

ARG SOURCE

# Conditionally copy from the appropriate stage based on SOURCE arg
COPY --from=binary-downloader /download/status /tmp/download-status

# Select the right package: binary if available and SOURCE!=true, otherwise source
RUN if [ "${SOURCE}" = "true" ]; then \
      echo "Using source build (forced)" && \
      BUILD_SOURCE="source"; \
    elif [ -f /tmp/download-status ] && grep -q "SUCCESS" /tmp/download-status; then \
      echo "Using pre-built binary" && \
      BUILD_SOURCE="binary"; \
    else \
      echo "Binary not available, using source build" && \
      BUILD_SOURCE="source"; \
    fi && \
    echo "${BUILD_SOURCE}" > /tmp/build-source && \
    rm -f /tmp/download-status

# Copy only the selected package
COPY --from=source-builder /app/package /tmp/source-package
COPY --from=binary-downloader /download/package /tmp/binary-package

RUN BUILD_SOURCE=$(cat /tmp/build-source) && \
    if [ "${BUILD_SOURCE}" = "binary" ]; then \
      if [ ! -f /tmp/binary-package/agent ]; then \
        echo "ERROR: Binary package missing agent executable" && \
        exit 1; \
      fi && \
      mv /tmp/binary-package/* /app/ || { echo "ERROR: Failed to move binary package"; exit 1; }; \
    else \
      if [ ! -f /tmp/source-package/agent ]; then \
        echo "ERROR: Source package missing agent executable" && \
        exit 1; \
      fi && \
      mv /tmp/source-package/* /app/ || { echo "ERROR: Failed to move source package"; exit 1; }; \
    fi && \
    rm -rf /tmp/source-package /tmp/binary-package /tmp/build-source && \
    chmod +x /app/agent && \
    /app/agent --version || { echo "ERROR: Agent binary is not executable or corrupted"; exit 1; }

# Allow configuring agent UID at build time to avoid host permission issues
ARG AGENT_UID=1000

# Create non-root user with configurable UID
RUN adduser -D -u "$AGENT_UID" -h /home/agent agent

# Create sandbox marker file (before switching to non-root user)
RUN touch /.agent-sandbox

# Switch to non-root user
USER agent
WORKDIR /workspace

# Environment marker
ENV AGENT_SANDBOX=true

# Config volume (mounted from host for sessions/plugins)
VOLUME ["/home/agent/.agent"]

# Workspace volume (mounted read-write from host)
VOLUME ["/workspace"]

ENTRYPOINT ["/app/agent"]
CMD ["--help"]
